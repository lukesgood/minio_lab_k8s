# Lab 11 핵심 개념: Multi-Tenant 관리와 리소스 격리

## 📚 개요

Lab 11에서는 MinIO의 Multi-Tenant 아키텍처를 통해 하나의 Kubernetes 클러스터에서 여러 독립적인 MinIO 환경을 운영하는 방법을 학습합니다. 이는 현대적인 클라우드 네이티브 환경에서 리소스 효율성과 격리성을 동시에 달성하는 핵심 기술입니다.

## 🎯 핵심 학습 목표

- Multi-Tenant 아키텍처의 이해와 구현
- Kubernetes 네임스페이스를 통한 논리적 격리
- ResourceQuota를 활용한 리소스 관리
- 네트워크 정책을 통한 보안 격리
- 테넌트별 사용자 및 정책 관리
- 운영 환경에서의 Multi-Tenant 관리 전략

## 🏗️ Multi-Tenant 아키텍처 개념

### 전통적인 단일 테넌트 vs Multi-Tenant

```
단일 테넌트 아키텍처:
┌─────────────────────────────────────────────────────────┐
│                  Physical Server 1                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              Application A                          │ │
│  │         (Dedicated Resources)                       │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                  Physical Server 2                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              Application B                          │ │
│  │         (Dedicated Resources)                       │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘

Multi-Tenant 아키텍처:
┌─────────────────────────────────────────────────────────┐
│                  Shared Infrastructure                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │   Tenant A  │  │   Tenant B  │  │   Tenant C  │     │
│  │   (Isolated)│  │   (Isolated)│  │   (Isolated)│     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│                                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │            Shared Resource Pool                     │ │
│  │    CPU | Memory | Storage | Network                │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### MinIO Multi-Tenant 계층 구조

```
MinIO Multi-Tenant 계층 구조:
┌─────────────────────────────────────────────────────────┐
│                  Management Layer                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │   MinIO     │  │ Kubernetes  │  │   Monitoring│     │
│  │  Operator   │  │   API       │  │   & Logging │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  Tenant Layer                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │   Dev       │  │   Staging   │  │   Prod      │     │
│  │  Tenant     │  │   Tenant    │  │  Tenant     │     │
│  │             │  │             │  │             │     │
│  │ • Low Res   │  │ • Med Res   │  │ • High Res  │     │
│  │ • Fast Dev  │  │ • Testing   │  │ • Stable    │     │
│  │ • Flexible  │  │ • Validation│  │ • Secure    │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  Isolation Layer                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Namespace   │  │  Resource   │  │  Network    │     │
│  │ Isolation   │  │   Quotas    │  │  Policies   │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                Infrastructure Layer                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Kubernetes  │  │   Storage   │  │   Network   │     │
│  │   Cluster   │  │    Layer    │  │    Layer    │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

## 🔧 Kubernetes 네임스페이스 기반 격리

### 네임스페이스의 역할과 기능

```
네임스페이스 격리 메커니즘:
┌─────────────────────────────────────────────────────────┐
│                  Kubernetes Cluster                     │
│                                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              Namespace: tenant-dev                  │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │ │
│  │  │    Pods     │  │  Services   │  │   Secrets   │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │ │
│  │  │    PVCs     │  │ ConfigMaps  │  │   Ingress   │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │             Namespace: tenant-prod                  │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │ │
│  │  │    Pods     │  │  Services   │  │   Secrets   │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │ │
│  │  │    PVCs     │  │ ConfigMaps  │  │   Ingress   │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 네임스페이스 격리의 장점

```
격리 수준별 비교:
┌─────────────────┬─────────────┬─────────────┬─────────────┐
│   격리 방법     │   리소스    │    보안     │   관리성    │
├─────────────────┼─────────────┼─────────────┼─────────────┤
│ 물리적 분리     │    최고     │    최고     │    복잡     │
├─────────────────┼─────────────┼─────────────┼─────────────┤
│ VM 기반 분리    │    높음     │    높음     │    중간     │
├─────────────────┼─────────────┼─────────────┼─────────────┤
│ 네임스페이스    │    중간     │    중간     │    간단     │
│ 기반 분리       │             │             │             │
├─────────────────┼─────────────┼─────────────┼─────────────┤
│ 프로세스 분리   │    낮음     │    낮음     │   매우간단  │
└─────────────────┴─────────────┴─────────────┴─────────────┘
```

## 📊 ResourceQuota를 통한 리소스 관리

### ResourceQuota의 핵심 개념

```
ResourceQuota 작동 원리:
┌─────────────────────────────────────────────────────────┐
│                  Namespace: tenant-dev                  │
│                                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              ResourceQuota                          │ │
│  │                                                     │ │
│  │  Hard Limits:                                       │ │
│  │  • requests.cpu: "2"                                │ │
│  │  • requests.memory: 4Gi                             │ │
│  │  • limits.cpu: "4"                                  │ │
│  │  • limits.memory: 8Gi                               │ │
│  │  • requests.storage: 50Gi                           │ │
│  │  • persistentvolumeclaims: "10"                     │ │
│  │  • pods: "20"                                       │ │
│  │  • services: "10"                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                           │                             │
│                           ▼                             │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              Current Usage                          │ │
│  │                                                     │ │
│  │  Used:                                              │ │
│  │  • requests.cpu: "1.5" (75%)                        │ │
│  │  • requests.memory: 3Gi (75%)                       │ │
│  │  • limits.cpu: "3" (75%)                            │ │
│  │  • limits.memory: 6Gi (75%)                         │ │
│  │  • requests.storage: 30Gi (60%)                     │ │
│  │  • persistentvolumeclaims: "6" (60%)                │ │
│  │  • pods: "12" (60%)                                 │ │
│  │  • services: "5" (50%)                              │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 리소스 할당 전략

```
환경별 리소스 할당 전략:
┌─────────────────────────────────────────────────────────┐
│                    개발 환경 (Dev)                      │
│  특성: 빠른 개발, 실험, 테스트                          │
│  ┌─────────────┬─────────────┬─────────────┬───────────┐ │
│  │    CPU      │   Memory    │   Storage   │   Pods    │ │
│  │   1-2 Core  │   2-4 GB    │   10-50 GB  │   10-20   │ │
│  └─────────────┴─────────────┴─────────────┴───────────┘ │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                   스테이징 환경 (Staging)               │
│  특성: 프로덕션 시뮬레이션, 성능 테스트                 │
│  ┌─────────────┬─────────────┬─────────────┬───────────┐ │
│  │    CPU      │   Memory    │   Storage   │   Pods    │ │
│  │   2-4 Core  │   4-8 GB    │  50-200 GB  │   20-50   │ │
│  └─────────────┴─────────────┴─────────────┴───────────┘ │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                  프로덕션 환경 (Production)             │
│  특성: 안정성, 고성능, 고가용성                         │
│  ┌─────────────┬─────────────┬─────────────┬───────────┐ │
│  │    CPU      │   Memory    │   Storage   │   Pods    │ │
│  │   4-8 Core  │  8-16 GB    │ 200-500 GB  │  50-100   │ │
│  └─────────────┴─────────────┴─────────────┴───────────┘ │
└─────────────────────────────────────────────────────────┘
```
## 🌐 네트워크 정책을 통한 보안 격리

### 네트워크 정책의 필요성

```
네트워크 정책 없는 환경:
┌─────────────────────────────────────────────────────────┐
│                  Kubernetes Cluster                     │
│                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ │
│  │   Dev       │◀──▶│  Staging    │◀──▶│    Prod     │ │
│  │  Tenant     │    │   Tenant    │    │   Tenant    │ │
│  │             │    │             │    │             │ │
│  │ ⚠️ 모든 Pod │    │ ⚠️ 모든 Pod │    │ ⚠️ 모든 Pod │ │
│  │ 간 통신 가능│    │ 간 통신 가능│    │ 간 통신 가능│ │
│  └─────────────┘    └─────────────┘    └─────────────┘ │
│         │                   │                   │     │
│         └───────────────────┼───────────────────┘     │
│                             │                         │
│                    ⚠️ 보안 위험                        │
└─────────────────────────────────────────────────────────┘

네트워크 정책 적용 후:
┌─────────────────────────────────────────────────────────┐
│                  Kubernetes Cluster                     │
│                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ │
│  │   Dev       │ ✗  │  Staging    │ ✗  │    Prod     │ │
│  │  Tenant     │    │   Tenant    │    │   Tenant    │ │
│  │             │    │             │    │             │ │
│  │ ✅ 내부     │    │ ✅ 내부     │    │ ✅ 내부     │ │
│  │ 통신만 허용 │    │ 통신만 허용 │    │ 통신만 허용 │ │
│  └─────────────┘    └─────────────┘    └─────────────┘ │
│                                                         │
│                    ✅ 보안 강화                         │
└─────────────────────────────────────────────────────────┘
```

## 👥 테넌트별 사용자 및 정책 관리

### 환경별 사용자 권한 매트릭스

```
환경별 사용자 권한 매트릭스:
┌─────────────────┬─────────────┬─────────────┬─────────────┐
│   사용자 유형   │    Dev      │   Staging   │    Prod     │
├─────────────────┼─────────────┼─────────────┼─────────────┤
│ 개발자          │ 읽기/쓰기   │    읽기     │    없음     │
│ (Developer)     │ 버킷 생성   │    없음     │    없음     │
│                 │ 사용자 관리 │    없음     │    없음     │
├─────────────────┼─────────────┼─────────────┼─────────────┤
│ 테스터          │    읽기     │ 읽기/쓰기   │    읽기     │
│ (Tester)        │    없음     │ 버킷 생성   │    없음     │
│                 │    없음     │    없음     │    없음     │
├─────────────────┼─────────────┼─────────────┼─────────────┤
│ 운영자          │    읽기     │    읽기     │ 읽기/쓰기   │
│ (Operator)      │    없음     │    없음     │ 버킷 관리   │
│                 │    없음     │    없음     │ 사용자 관리 │
├─────────────────┼─────────────┼─────────────┼─────────────┤
│ 관리자          │   모든권한  │   모든권한  │   모든권한  │
│ (Admin)         │             │             │             │
└─────────────────┴─────────────┴─────────────┴─────────────┘
```

## 📊 실무 구현 가이드

### Multi-Tenant 배포 전략

```
단계별 Multi-Tenant 구현:
┌─────────────────────────────────────────────────────────┐
│                    Phase 1: 기반 구축                   │
│  1. Kubernetes 클러스터 준비                            │
│  2. MinIO Operator 설치                                 │
│  3. 스토리지 클래스 설정                                 │
│  4. 네트워크 정책 준비                                   │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    Phase 2: 테넌트 생성                 │
│  1. 네임스페이스 생성 및 라벨링                         │
│  2. ResourceQuota 설정                                  │
│  3. 테넌트별 시크릿 생성                                 │
│  4. MinIO Tenant 리소스 배포                            │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    Phase 3: 보안 설정                   │
│  1. 네트워크 정책 적용                                   │
│  2. RBAC 권한 설정                                       │
│  3. 사용자 및 정책 생성                                  │
│  4. 접근 제어 테스트                                     │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    Phase 4: 운영 준비                   │
│  1. 모니터링 설정                                        │
│  2. 로깅 및 감사 설정                                    │
│  3. 백업 및 복구 계획                                    │
│  4. 자동화 스크립트 배포                                 │
└─────────────────────────────────────────────────────────┘
```

### 운영 모범 사례

```
Multi-Tenant 운영 체크리스트:
┌─────────────────────────────────────────────────────────┐
│                    일일 운영 작업                       │
│  □ 테넌트별 리소스 사용량 확인                          │
│  □ ResourceQuota 한계 근접 알림 확인                    │
│  □ 네트워크 정책 위반 로그 검토                         │
│  □ 사용자 접근 로그 분석                                 │
│  □ 백업 상태 확인                                        │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    주간 운영 작업                       │
│  □ 테넌트별 성능 분석 및 최적화                         │
│  □ 리소스 할당 재검토                                    │
│  □ 사용자 권한 정기 검토                                 │
│  □ 보안 정책 업데이트 확인                               │
│  □ 비용 분석 및 차지백 계산                             │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    월간 운영 작업                       │
│  □ 테넌트 확장/축소 계획 수립                           │
│  □ 전체 아키텍처 검토                                    │
│  □ 재해 복구 테스트 실시                                 │
│  □ 성능 벤치마크 및 용량 계획                           │
│  □ 정책 및 절차 업데이트                                 │
└─────────────────────────────────────────────────────────┘
```

## 🔧 트러블슈팅 가이드

### 일반적인 문제와 해결책

#### 1. 테넌트 배포 실패
```bash
# 문제: Pod가 Pending 상태
# 원인: ResourceQuota 초과 또는 노드 리소스 부족

# 해결 방법:
kubectl describe pod <pod-name> -n <tenant-namespace>
kubectl get resourcequota -n <tenant-namespace>
kubectl top nodes
```

#### 2. 네트워크 연결 문제
```bash
# 문제: 테넌트 간 통신 차단
# 원인: 네트워크 정책 설정 오류

# 해결 방법:
kubectl get networkpolicy -n <tenant-namespace>
kubectl describe networkpolicy <policy-name> -n <tenant-namespace>
```

#### 3. 사용자 접근 권한 문제
```bash
# 문제: 사용자가 버킷에 접근할 수 없음
# 원인: 정책 설정 오류 또는 사용자-정책 매핑 문제

# 해결 방법:
mc admin user list <alias>
mc admin policy list <alias>
mc admin policy info <policy-name> <alias>
```

## 📈 확장성 고려사항

### 수평 확장 전략

```
Multi-Tenant 확장 시나리오:
┌─────────────────────────────────────────────────────────┐
│                    현재 상태 (3 테넌트)                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │     Dev     │  │   Staging   │  │    Prod     │     │
│  │   Tenant    │  │   Tenant    │  │   Tenant    │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    확장 후 (6 테넌트)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │     Dev     │  │   Staging   │  │    Prod     │     │
│  │   Tenant    │  │   Tenant    │  │   Tenant    │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │    Test     │  │   Demo      │  │   Backup    │     │
│  │   Tenant    │  │   Tenant    │  │   Tenant    │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 성능 최적화 전략

```
테넌트별 성능 최적화:
┌─────────────────────────────────────────────────────────┐
│                    리소스 최적화                        │
│                                                         │
│  CPU 최적화:                                            │
│  • 테넌트별 CPU 요청량 모니터링                         │
│  • 피크 시간대 분산 배치                                 │
│  • CPU 제한값 동적 조정                                 │
│                                                         │
│  메모리 최적화:                                          │
│  • 메모리 사용 패턴 분석                                 │
│  • 캐시 크기 최적화                                      │
│  • OOM 방지를 위한 여유 공간 확보                       │
│                                                         │
│  스토리지 최적화:                                        │
│  • 스토리지 클래스별 성능 특성 활용                     │
│  • 데이터 계층화 (Hot/Warm/Cold)                       │
│  • 압축 및 중복 제거 활용                               │
│                                                         │
│  네트워크 최적화:                                        │
│  • 테넌트별 대역폭 제한                                  │
│  • 네트워크 지연시간 최소화                             │
│  • 로드 밸런싱 최적화                                    │
└─────────────────────────────────────────────────────────┘
```

## 📚 추가 학습 자료

### 관련 기술 및 도구
- **Kubernetes**: 네임스페이스, ResourceQuota, NetworkPolicy
- **MinIO Operator**: CRD, 테넌트 관리, 자동화
- **모니터링**: Prometheus, Grafana, Kubernetes 메트릭
- **보안**: RBAC, 네트워크 정책, Pod 보안 정책

### 참고 문서
- [Kubernetes Multi-Tenancy](https://kubernetes.io/docs/concepts/security/multi-tenancy/)
- [MinIO Operator Documentation](https://github.com/minio/operator)
- [Kubernetes Network Policies](https://kubernetes.io/docs/concepts/services-networking/network-policies/)
- [Resource Quotas](https://kubernetes.io/docs/concepts/policy/resource-quotas/)

---

이 문서는 Lab 11에서 다루는 Multi-Tenant 관리의 핵심 개념들을 체계적으로 정리한 것입니다. 실습을 통해 이론을 실제로 구현해보면서 운영 환경에서 활용할 수 있는 실무 지식을 습득하시기 바랍니다.
## 🔍 Multi-Tenant 아키텍처 상세 분석

### Multi-Tenancy의 핵심 원리

Multi-Tenancy는 단일 소프트웨어 인스턴스가 여러 고객(테넌트)에게 서비스를 제공하는 아키텍처 패턴입니다. MinIO에서 이는 하나의 Kubernetes 클러스터에서 여러 독립적인 MinIO 인스턴스를 운영하는 것을 의미합니다.

#### 테넌트 격리의 4가지 차원

```
Multi-Tenant 격리 차원:
┌─────────────────────────────────────────────────────────┐
│                    1. 데이터 격리                       │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  • 물리적 분리: 각 테넌트별 전용 스토리지 볼륨     │ │
│  │  • 논리적 분리: 네임스페이스 기반 리소스 분리       │ │
│  │  • 암호화 분리: 테넌트별 독립적인 암호화 키         │ │
│  │  • 백업 분리: 테넌트별 독립적인 백업 정책           │ │
│  │                                                     │ │
│  │  예시: tenant-dev의 데이터는 tenant-prod에서        │ │
│  │       절대 접근할 수 없도록 보장                    │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    2. 컴퓨팅 격리                       │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  • CPU 격리: ResourceQuota를 통한 CPU 사용량 제한  │ │
│  │  • 메모리 격리: 테넌트별 메모리 할당량 관리         │ │
│  │  • 프로세스 격리: 컨테이너 기반 프로세스 분리       │ │
│  │  • 스케줄링 격리: 노드 어피니티 기반 배치 제어      │ │
│  │                                                     │ │
│  │  예시: 개발 환경은 최대 2 CPU 코어만 사용 가능      │ │
│  │       프로덕션 환경은 최대 8 CPU 코어 사용 가능     │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    3. 네트워크 격리                     │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  • L3 격리: NetworkPolicy를 통한 IP 레벨 차단       │ │
│  │  • L4 격리: 포트 기반 접근 제어                     │ │
│  │  • L7 격리: 애플리케이션 레벨 접근 제어             │ │
│  │  • DNS 격리: 테넌트별 독립적인 서비스 디스커버리    │ │
│  │                                                     │ │
│  │  예시: tenant-dev 네임스페이스의 Pod는              │ │
│  │       tenant-prod 네임스페이스로 통신 불가          │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    4. 관리 격리                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  • 권한 격리: RBAC를 통한 관리 권한 분리            │ │
│  │  • 모니터링 격리: 테넌트별 독립적인 메트릭 수집     │ │
│  │  • 로깅 격리: 테넌트별 로그 스트림 분리             │ │
│  │  • 설정 격리: 테넌트별 독립적인 구성 관리           │ │
│  │                                                     │ │
│  │  예시: 개발팀은 개발 환경만 관리 가능               │ │
│  │       운영팀은 모든 환경 관리 가능                  │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### Kubernetes 네임스페이스 심화 이해

#### 네임스페이스의 내부 동작 원리

Kubernetes 네임스페이스는 클러스터 내에서 가상의 클러스터를 만드는 메커니즘입니다. 각 네임스페이스는 독립적인 DNS 도메인을 가지며, 리소스 이름의 충돌을 방지합니다.

```
네임스페이스 DNS 구조:
┌─────────────────────────────────────────────────────────┐
│                  Kubernetes DNS                         │
│                                                         │
│  서비스 FQDN 구조:                                      │
│  <service-name>.<namespace>.svc.cluster.local          │
│                                                         │
│  예시:                                                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ tenant-dev 네임스페이스:                            │ │
│  │ minio.tenant-dev.svc.cluster.local                  │ │
│  │ minio-console.tenant-dev.svc.cluster.local          │ │
│  │                                                     │ │
│  │ tenant-prod 네임스페이스:                           │ │
│  │ minio.tenant-prod.svc.cluster.local                 │ │
│  │ minio-console.tenant-prod.svc.cluster.local         │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  네임스페이스 간 통신:                                  │
│  • 기본적으로 모든 네임스페이스 간 통신 허용            │
│  • NetworkPolicy로 제한 가능                           │
│  • DNS 해석을 통한 서비스 디스커버리                   │
└─────────────────────────────────────────────────────────┘
```

## 📊 ResourceQuota 심화 분석

### ResourceQuota 동작 메커니즘

ResourceQuota는 Kubernetes의 Admission Controller 중 하나로, 리소스 생성 요청을 가로채서 할당량을 검사합니다.

```
ResourceQuota 처리 흐름:
┌─────────────────────────────────────────────────────────┐
│                    사용자 요청                          │
│  kubectl apply -f pod.yaml                              │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  API Server                             │
│  ┌─────────────────────────────────────────────────────┐ │
│  │            Admission Controllers                    │ │
│  │                                                     │ │
│  │  1. MutatingAdmissionWebhook                        │ │
│  │     • 리소스 수정 (기본값 설정 등)                  │ │
│  │                                                     │ │
│  │  2. ResourceQuota Controller ← 여기서 검사!         │ │
│  │     • 현재 사용량 조회                              │ │
│  │     • 요청량과 한계량 비교                          │ │
│  │     • 승인/거부 결정                                │ │
│  │                                                     │ │
│  │  3. ValidatingAdmissionWebhook                      │ │
│  │     • 최종 검증                                     │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    결과                                 │
│                                                         │
│  승인된 경우:                                           │
│  • etcd에 리소스 저장                                   │
│  • 스케줄러가 Pod 배치                                  │
│  • ResourceQuota 사용량 업데이트                        │
│                                                         │
│  거부된 경우:                                           │
│  • 오류 메시지 반환                                     │
│  • "exceeded quota" 에러                               │
│  • 리소스 생성 실패                                     │
└─────────────────────────────────────────────────────────┘
```

## 🌐 네트워크 정책 상세 구현

### NetworkPolicy 심화 이해

NetworkPolicy는 Kubernetes에서 Pod 간의 네트워크 트래픽을 제어하는 방법입니다. 이는 방화벽 규칙과 유사하지만, Kubernetes 네이티브 방식으로 구현됩니다.

```
NetworkPolicy 작동 원리:
┌─────────────────────────────────────────────────────────┐
│                  CNI Plugin Layer                       │
│  (Calico, Cilium, Weave Net 등)                        │
│                                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │            iptables Rules                           │ │
│  │                                                     │ │
│  │  # 개발 환경에서 프로덕션으로의 트래픽 차단          │ │
│  │  iptables -A FORWARD -s 10.244.1.0/24 \            │ │
│  │           -d 10.244.2.0/24 -j DROP                  │ │
│  │                                                     │ │
│  │  # 같은 네임스페이스 내 통신 허용                   │ │
│  │  iptables -A FORWARD -s 10.244.1.0/24 \            │ │
│  │           -d 10.244.1.0/24 -j ACCEPT                │ │
│  │                                                     │ │
│  │  # 특정 포트만 허용 (MinIO API: 9000)              │ │
│  │  iptables -A FORWARD -p tcp --dport 9000 \          │ │
│  │           -s 0.0.0.0/0 -j ACCEPT                    │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  Packet Flow                            │
│                                                         │
│  Pod A (tenant-dev) → Pod B (tenant-prod)               │
│                                                         │
│  1. 패킷 생성: Pod A에서 Pod B로 HTTP 요청              │
│  2. CNI 검사: NetworkPolicy 규칙 확인                   │
│  3. 규칙 적용: tenant-dev → tenant-prod 차단            │
│  4. 패킷 드롭: 연결 실패, 타임아웃 발생                 │
│                                                         │
│  Pod A (tenant-dev) → Pod C (tenant-dev)                │
│                                                         │
│  1. 패킷 생성: 같은 네임스페이스 내 통신                │
│  2. CNI 검사: 같은 네임스페이스 규칙 확인               │
│  3. 규칙 적용: 허용                                     │
│  4. 패킷 전달: 정상 통신                                │
└─────────────────────────────────────────────────────────┘
```

### 고급 네트워크 정책 패턴

```
계층적 네트워크 보안 모델:
┌─────────────────────────────────────────────────────────┐
│                    Tier 1: 기본 격리                    │
│  모든 테넌트 간 기본 차단                               │
│                                                         │
│  apiVersion: networking.k8s.io/v1                       │
│  kind: NetworkPolicy                                    │
│  metadata:                                              │
│    name: default-deny-all                               │
│  spec:                                                  │
│    podSelector: {}                                      │
│    policyTypes:                                         │
│    - Ingress                                            │
│    - Egress                                             │
│    # 빈 ingress/egress = 모든 트래픽 차단               │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    Tier 2: 선택적 허용                  │
│  필요한 통신만 명시적으로 허용                          │
│                                                         │
│  apiVersion: networking.k8s.io/v1                       │
│  kind: NetworkPolicy                                    │
│  metadata:                                              │
│    name: allow-same-namespace                           │
│  spec:                                                  │
│    podSelector: {}                                      │
│    policyTypes:                                         │
│    - Ingress                                            │
│    - Egress                                             │
│    ingress:                                             │
│    - from:                                              │
│      - namespaceSelector:                               │
│          matchLabels:                                   │
│            name: tenant-dev  # 같은 네임스페이스만      │
│    egress:                                              │
│    - to:                                                │
│      - namespaceSelector:                               │
│          matchLabels:                                   │
│            name: tenant-dev  # 같은 네임스페이스만      │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    Tier 3: 서비스별 허용                │
│  특정 서비스 포트만 외부 접근 허용                      │
│                                                         │
│  apiVersion: networking.k8s.io/v1                       │
│  kind: NetworkPolicy                                    │
│  metadata:                                              │
│    name: allow-minio-api                                │
│  spec:                                                  │
│    podSelector:                                         │
│      matchLabels:                                       │
│        app: minio                                       │
│    policyTypes:                                         │
│    - Ingress                                            │
│    ingress:                                             │
│    - from: []  # 모든 소스에서                          │
│      ports:                                             │
│      - protocol: TCP                                    │
│        port: 9000  # MinIO API 포트만                   │
│      - protocol: TCP                                    │
│        port: 9090  # MinIO Console 포트만               │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    Tier 4: 모니터링 허용                │
│  모니터링 시스템의 메트릭 수집 허용                     │
│                                                         │
│  apiVersion: networking.k8s.io/v1                       │
│  kind: NetworkPolicy                                    │
│  metadata:                                              │
│    name: allow-monitoring                               │
│  spec:                                                  │
│    podSelector: {}                                      │
│    policyTypes:                                         │
│    - Ingress                                            │
│    ingress:                                             │
│    - from:                                              │
│      - namespaceSelector:                               │
│          matchLabels:                                   │
│            name: monitoring  # 모니터링 네임스페이스    │
│      ports:                                             │
│      - protocol: TCP                                    │
│        port: 9000  # 메트릭 엔드포인트                  │
└─────────────────────────────────────────────────────────┘
```

## 👥 사용자 관리 심화 전략

### 계층적 사용자 관리 모델

```
사용자 관리 계층 구조 상세:
┌─────────────────────────────────────────────────────────┐
│                  Global Administrators                  │
│  (클러스터 전체 관리 권한)                              │
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Platform    │  │ Security    │  │ Infrastructure │  │
│  │ Admin       │  │ Admin       │  │ Admin          │  │
│  │             │  │             │  │                │  │
│  │ • 모든 테넌트│  │ • 보안 정책│  │ • 클러스터     │  │
│  │   관리      │  │   관리      │  │   리소스       │  │
│  │ • 사용자    │  │ • 감사 로그 │  │ • 노드 관리    │  │
│  │   생성/삭제 │  │   검토      │  │ • 네트워크     │  │
│  │ • 정책 설정 │  │ • 인증서    │  │   설정         │  │
│  │             │  │   관리      │  │                │  │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  Tenant Administrators                  │
│  (특정 테넌트 관리 권한)                                │
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Dev Team    │  │ Staging     │  │ Production  │     │
│  │ Admin       │  │ Admin       │  │ Admin       │     │
│  │             │  │             │  │             │     │
│  │ • dev 테넌트│  │ • staging   │  │ • prod      │     │
│  │   전체 관리 │  │   테넌트    │  │   테넌트    │     │
│  │ • 개발자    │  │   관리      │  │   관리      │     │
│  │   계정 관리 │  │ • QA 팀     │  │ • 운영팀    │     │
│  │ • 개발 정책 │  │   계정 관리 │  │   계정 관리 │     │
│  │   설정      │  │ • 테스트    │  │ • 프로덕션  │     │
│  │             │  │   정책 설정 │  │   정책 설정 │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    End Users                            │
│  (실제 애플리케이션 사용자)                             │
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Developers  │  │ Testers     │  │ Operators   │     │
│  │             │  │             │  │             │     │
│  │ • 개발 버킷 │  │ • 테스트    │  │ • 프로덕션  │     │
│  │   읽기/쓰기 │  │   버킷      │  │   버킷      │     │
│  │ • 임시 버킷 │  │   읽기/쓰기 │  │   읽기 전용 │     │
│  │   생성/삭제 │  │ • 테스트    │  │ • 모니터링  │     │
│  │ • 로그 접근 │  │   데이터    │  │   데이터    │     │
│  │             │  │   업로드    │  │   접근      │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 정책 기반 접근 제어 (PBAC) 상세 구현

```
정책 엔진 동작 흐름:
┌─────────────────────────────────────────────────────────┐
│                    요청 수신                            │
│  GET /dev-bucket/project-a/data.json                    │
│  User: john.developer@company.com                       │
│  IP: 192.168.1.100                                      │
│  Time: 2024-01-15 14:30:00                              │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  1. 사용자 인증                         │
│                                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  인증 방법 확인:                                    │ │
│  │  • JWT 토큰 검증                                    │ │
│  │  • 토큰 만료 시간 확인                              │ │
│  │  • 사용자 존재 여부 확인                            │ │
│  │  • 계정 활성 상태 확인                              │ │
│  │                                                     │ │
│  │  결과: ✅ 인증 성공                                  │ │
│  │  사용자: john.developer@company.com                 │ │
│  │  역할: Developer                                    │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  2. 정책 조회                           │
│                                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  사용자별 정책 매핑:                                │ │
│  │  john.developer@company.com → dev-policy            │ │
│  │                                                     │ │
│  │  dev-policy 내용:                                   │ │
│  │  {                                                  │ │
│  │    "Version": "2012-10-17",                         │ │
│  │    "Statement": [                                   │ │
│  │      {                                              │ │
│  │        "Effect": "Allow",                           │ │
│  │        "Action": ["s3:GetObject", "s3:PutObject"],  │ │
│  │        "Resource": "arn:aws:s3:::dev-*/*",          │ │
│  │        "Condition": {                               │ │
│  │          "IpAddress": {                             │ │
│  │            "aws:SourceIp": "192.168.1.0/24"        │ │
│  │          },                                         │ │
│  │          "DateGreaterThan": {                       │ │
│  │            "aws:CurrentTime": "2024-01-01T00:00:00Z"│ │
│  │          }                                          │ │
│  │        }                                            │ │
│  │      }                                              │ │
│  │    ]                                                │ │
│  │  }                                                  │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  3. 권한 평가                           │
│                                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  평가 항목:                                         │ │
│  │                                                     │ │
│  │  ✅ Action 확인:                                    │ │
│  │     요청: s3:GetObject                              │ │
│  │     정책: s3:GetObject 허용됨                       │ │
│  │                                                     │ │
│  │  ✅ Resource 확인:                                  │ │
│  │     요청: arn:aws:s3:::dev-bucket/project-a/data.json│ │
│  │     정책: arn:aws:s3:::dev-*/* 패턴 매치            │ │
│  │                                                     │ │
│  │  ✅ Condition 확인:                                 │ │
│  │     IP 주소: 192.168.1.100 ∈ 192.168.1.0/24        │ │
│  │     시간: 2024-01-15 > 2024-01-01                   │ │
│  │                                                     │ │
│  │  최종 결과: ALLOW ✅                                │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  4. 감사 로그 기록                      │
│                                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  {                                                  │ │
│  │    "timestamp": "2024-01-15T14:30:00Z",             │ │
│  │    "user": "john.developer@company.com",            │ │
│  │    "action": "s3:GetObject",                        │ │
│  │    "resource": "dev-bucket/project-a/data.json",    │ │
│  │    "sourceIP": "192.168.1.100",                     │ │
│  │    "userAgent": "MinIO Client/7.0.0",               │ │
│  │    "policy": "dev-policy",                          │ │
│  │    "decision": "ALLOW",                             │ │
│  │    "responseTime": "45ms",                          │ │
│  │    "responseSize": "1024 bytes"                     │ │
│  │  }                                                  │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```
